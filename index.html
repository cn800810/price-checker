<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>价格查询</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f5f5f5;
}

h2 {
  text-align: center;
  margin: 20px 0 10px;
}

.input-box {
  width: 85%;
  max-width: 360px;
  margin: auto;
  display: flex;
  flex-direction: column;
}

input {
  padding: 12px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #aaa;
  margin-bottom: 10px;
}

button {
  padding: 12px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  background: #2d89ef;
  color: white;
}

#openListBtn {
  background: #444;
  margin-top: 6px;
}

/* ===== 弹窗 ===== */
.overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  align-items: center;
  justify-content: center;
  z-index: 50;
}

.modal {
  background: white;
  width: 90%;
  max-width: 420px;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  position: relative;
}

.close-btn {
  position: absolute;
  top: 10px;
  right: 12px;
}

#modalImage {
  max-width: 90%;
  border-radius: 10px;
  margin: 10px auto;
  display: none;
}

#modalPrice {
  font-size: 28px;
  color: green;
  margin: 10px 0;
}

.small {
  font-size: 14px;
  color: #666;
}
</style>
</head>

<body>

<h2>价格查询</h2>

<div class="input-box">
  <input id="codeInput" placeholder="输入商品编码">
  <button onclick="search()">查询</button>
  <button id="openListBtn" onclick="openList()">商品目录</button>
</div>

<!-- 弹窗 -->
<div id="overlay" class="overlay">
  <div class="modal">
    <button class="close-btn" onclick="closeModal()">X</button>

    <h3 id="modalTitle"></h3>
    <div id="modalCode" class="small"></div>

    < img id="modalImage">

    <input id="nameInput" placeholder="商品名称">
    <input id="priceInput" type="number" placeholder="价格">

    <input type="file" id="imgInput">

    <div id="modalPrice"></div>

    <button onclick="save()">保存</button>
    <button onclick="del()" style="background:#d9534f;margin-top:6px;">删除</button>
  </div>
</div>

<script>
/* ===== Supabase 配置 ===== */
const supabase = supabaseJs.createClient(
  'https://ikdxkrmpuyvkoifmfzcu.supabase.co',
  'sb_publishable_WJFKBCmGiyz4Wm1lVoTUfQ_HevLelwn'
)

/* ===== 查询 ===== */
async function search() {
  const code = codeInput.value.trim()
  if (!code) return alert('请输入编码')

  const { data } = await supabase
    .from('products')
    .select('*')
    .eq('code', code)
    .single()

  openModal(code, data)
}

/* ===== 打开弹窗 ===== */
function openModal(code, data) {
  overlay.style.display = 'flex'
  modalCode.innerText = '编码：' + code
  modalCode.dataset.code = code

  if (data) {
    modalTitle.innerText = '查询成功'
    nameInput.value = data.name || ''
    priceInput.value = data.price || ''
    modalPrice.innerText = '¥ ' + data.price
    if (data.image) {
      modalImage.src = data.image
      modalImage.style.display = 'block'
    }
  } else {
    modalTitle.innerText = '未录入，请新增'
    nameInput.value = ''
    priceInput.value = ''
    modalPrice.innerText = ''
    modalImage.style.display = 'none'
  }
}

/* ===== 保存 ===== */
async function save() {
  const code = modalCode.dataset.code
  const name = nameInput.value
  const price = priceInput.value

  let image = null
  if (imgInput.files[0]) {
    const reader = new FileReader()
    reader.onload = async e => {
      image = e.target.result
      await upsert(code, name, price, image)
    }
    reader.readAsDataURL(imgInput.files[0])
  } else {
    await upsert(code, name, price, null)
  }
}

async function upsert(code, name, price, image) {
  await supabase.from('products').upsert({
    code, name, price, image
  })
  alert('已保存')
  closeModal()
}

/* ===== 删除 ===== */
async function del() {
  const code = modalCode.dataset.code
  if (!confirm('确认删除？')) return
  await supabase.from('products').delete().eq('code', code)
  alert('已删除')
  closeModal()
}

function closeModal() {
  overlay.style.display = 'none'
}
</script>

</body>
</html>
