<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>价格查询（多人共享）</title>

<!-- Supabase 官方 SDK -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { font-family: Arial, background:#f5f5f5; margin:0; }
h2 { text-align:center; margin:20px 0; }
.input-box { width:90%; max-width:400px; margin:auto; }
input,button {
  width:100%; padding:12px; font-size:18px; margin-top:10px;
}
button {
  background:#2d89ef; color:#fff; border:none; border-radius:8px;
}
#list { padding:10px; max-width:400px; margin:auto; }
.item {
  background:#fff; padding:10px; margin:10px 0; border-radius:8px;
}
.price { color:green; font-size:20px; }
.error { color:red; text-align:center; margin-top:10px; }
</style>
</head>

<body>

<h2>价格查询（多人共享）</h2>

<div class="input-box">
  <input id="codeInput" placeholder="输入商品代码"/>
  <button onclick="search()">查询 / 保存</button>
  <div id="error" class="error"></div>
</div>

<div id="list"></div>

<script>
/* ========= Supabase 初始化 ========= */
const supabase = window.supabase.createClient(
  "https://ikdxkrmpuyvkoifmfzcu.supabase.co",
  "sb_publishable_WJFKBCmGiyz4Wm1lVoTUfQ_HevLelwn" // ← 必须和后台大小写完全一致
);

console.log("Supabase connected");

/* ========= 查询 / 保存 ========= */
async function search(){
  const code = document.getElementById("codeInput").value.trim();
  const errorBox = document.getElementById("error");
  errorBox.textContent = "";

  if(!code){
    alert("请输入商品代码");
    return;
  }

  const { data, error } = await supabase
    .from("products")
    .select("*")
    .eq("code", code)
    .maybeSingle();

  if(error){
    errorBox.textContent = "读取失败：" + error.message;
    return;
  }

  if(data){
    const price = prompt(
      "当前价格：" + (data.price ?? "未设置") + "\n输入新价格：",
      data.price ?? ""
    );
    if(price !== null){
      await supabase
        .from("products")
        .update({ price })
        .eq("code", code);
    }
  }else{
    const price = prompt("新商品，输入价格：");
    if(price !== null){
      await supabase
        .from("products")
        .insert({ code, price });
    }
  }

  loadList();
}

/* ========= 加载列表 ========= */
async function loadList(){
  const { data, error } = await supabase
    .from("products")
    .select("*")
    .order("created_at", { ascending:false });

  const list = document.getElementById("list");
  list.innerHTML = "";

  if(error){
    document.getElementById("error").textContent =
      "无法读取数据（401）：请确认 SELECT 策略已开启";
    return;
  }

  data.forEach(p=>{
    const d = document.createElement("div");
    d.className = "item";
    d.innerHTML = `
      <div><b>${p.code}</b></div>
      <div class="price">¥ ${p.price ?? "未设置"}</div>
    `;
    list.appendChild(d);
  });
}

loadList();
</script>

</body>
</html>
