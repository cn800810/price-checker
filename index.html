<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä»·æ ¼æŸ¥è¯¢ï¼ˆå¸¦æœ¬åœ°åº“ï¼‰</title>

  <!-- QuaggaJS æ¡ç åº“ï¼ˆç”¨äºä¸€ç»´æ¡ç ï¼‰ -->
  <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

  <style>
    :root{
      --bg: #ffffff;
      --muted: #666;
      --primary: #2b6ddb;
      --accent: #e6eefc;
      --card: #fafafa;
    }
    html,body{height:100%;}
    body{
      margin:0;
      background:var(--bg);
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial;
      color:#111;
      padding:14px;
    }

    h1{
      text-align:center;
      margin:6px 0 14px;
      font-size:22px;
    }

    .center{display:flex;justify-content:center;align-items:center;}

    button{
      background:var(--primary);
      color:#fff;
      border:0;
      padding:10px 16px;
      border-radius:20px;
      font-size:16px;
    }
    button.ghost{
      background:transparent;
      color:var(--primary);
      border:1px solid var(--accent);
    }
    .controls{display:flex;gap:10px;justify-content:center;margin-bottom:12px;}
    #video-wrap{
      width:100%;
      max-width:540px;
      margin:0 auto;
      border:1px solid #ccc;
      height:380px;
      background:#000;
      position:relative;
      box-sizing:border-box;
    }
    #camera-preview{
      width:100%;
      height:100%;
      object-fit:cover;
      transform:scaleX(-1); /* flip for front/back consistency â€” Quagga uses mirrored canvas */
    }
    .scan-frame{
      position:absolute;
      left:50%;
      top:50%;
      width:70%;
      height:40%;
      transform:translate(-50%,-50%);
      border:2px dashed rgba(0,110,255,0.3);
      border-radius:8px;
      pointer-events:none;
    }

    #result-box{
      margin-top:12px;
      background:var(--card);
      border-radius:8px;
      padding:12px;
      font-size:16px;
      min-height:48px;
      box-sizing:border-box;
    }

    .muted{color:var(--muted);}

    .controls-row{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px;}
    input[type="text"], input[type="file"]{
      width:100%;
      padding:10px;
      border:1px solid #ddd;
      border-radius:8px;
      box-sizing:border-box;
      font-size:16px;
    }

    .col{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .list{
      margin-top:14px;
      border-top:1px solid #eee;
      padding-top:10px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    th,td{
      padding:8px 6px;
      border-bottom:1px solid #f0f0f0;
      text-align:left;
    }
    .actions button{
      margin-right:6px;
      padding:6px 8px;
      font-size:13px;
      border-radius:6px;
    }

    .small{font-size:13px;color:var(--muted);}

    .msg{
      margin-top:8px;color:#0b6; font-weight:600;
    }

    .warning{color:#d9534f;}
    .flex{display:flex;gap:8px;align-items:center;}
    .searchbox{display:flex;gap:8px;margin-top:8px;}
    .footer-note{font-size:12px;color:var(--muted);margin-top:8px;text-align:center;}
  </style>
</head>
<body>
  <h1>ğŸ“± å•†å“ä»·æ ¼æŸ¥è¯¢å·¥å…·</h1>

  <div class="controls center">
    <button id="start-btn">å¼€å§‹æ‰«ç </button>
    <button id="stop-btn" class="ghost">åœæ­¢</button>
    <button id="list-btn" class="ghost">å†å²</button>
  </div>

  <div id="video-wrap">
    <!-- Quagga å°†æŠŠè§†é¢‘æ¸²æŸ“åˆ°è¿™é‡Œ -->
    <div id="camera-preview" style="width:100%;height:100%"></div>
    <div class="scan-frame"></div>
  </div>

  <div id="result-box" class="muted">å°šæœªæ‰«ç </div>

  <!-- ä»·æ ¼è¾“å…¥å¼¹å±‚ï¼ˆç®€å•æ˜¾ç¤º/éšè—ï¼‰ -->
  <div id="price-input-box" style="display:none;margin-top:10px;">
    <div style="display:flex;gap:8px">
      <input id="price-input" type="text" placeholder="è¾“å…¥ä»·æ ¼ï¼ˆå…ƒï¼‰" />
      <button id="save-price-btn">ä¿å­˜ä»·æ ¼</button>
      <button id="cancel-price-btn" class="ghost">å–æ¶ˆ</button>
    </div>
  </div>

  <div class="searchbox">
    <input id="search-input" placeholder="æœç´¢æ¡ç æˆ–ç‚¹å‡»å†å²æŸ¥çœ‹" />
    <button id="clear-search" class="ghost">æ¸…é™¤</button>
    <button id="export-btn">å¯¼å‡º CSV</button>
    <input id="import-file" type="file" accept=".csv" />
    <button id="clear-db" class="ghost">æ¸…ç©ºæœ¬åœ°åº“</button>
  </div>

  <div class="list" id="list-container" style="display:none;">
    <table id="price-table">
      <thead>
        <tr><th>æ¡ç </th><th>ä»·æ ¼ï¼ˆå…ƒï¼‰</th><th class="small">æ“ä½œ</th></tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

  <div class="footer-note">
    æ³¨æ„ï¼šiPhone Safari å¿…é¡»é€šè¿‡ HTTPSï¼ˆGitHub Pagesï¼‰æ‰èƒ½å¯ç”¨æ‘„åƒå¤´ã€‚è‹¥æ‘„åƒå¤´é»‘å±ï¼Œè¯·åˆ‡æ¢åˆ°å…‰çº¿å……è¶³ç¯å¢ƒå¹¶å…è®¸ç›¸æœºæƒé™ã€‚
  </div>

<script>
/* ========== ä»·æ ¼æ•°æ®åº“ï¼ˆlocalStorageï¼‰ ========== */
const DB_KEY = 'priceDB_v1';
let priceDB = {}; // { barcode: "12.50", ... }
function loadDB(){
  try{
    const raw = localStorage.getItem(DB_KEY);
    if(raw) priceDB = JSON.parse(raw) || {};
    else priceDB = {};
  }catch(e){ priceDB = {}; }
}
function saveDB(){
  localStorage.setItem(DB_KEY, JSON.stringify(priceDB));
}

/* ========== UI å…ƒç´  ========== */
const startBtn = document.getElementById('start-btn');
const stopBtn = document.getElementById('stop-btn');
const listBtn = document.getElementById('list-btn');
const resultBox = document.getElementById('result-box');
const videoWrap = document.getElementById('camera-preview');
const priceInputBox = document.getElementById('price-input-box');
const priceInput = document.getElementById('price-input');
const savePriceBtn = document.getElementById('save-price-btn');
const cancelPriceBtn = document.getElementById('cancel-price-btn');

const listContainer = document.getElementById('list-container');
const tableBody = document.getElementById('table-body');
const searchInput = document.getElementById('search-input');
const clearSearch = document.getElementById('clear-search');
const exportBtn = document.getElementById('export-btn');
const importFile = document.getElementById('import-file');
const clearDbBtn = document.getElementById('clear-db');

/* ========== Quagga æ‰«æç›¸å…³ ========== */
let scanning = false;
let lastDetected = null;

function showResult(html){
  resultBox.innerHTML = html;
}
function showTempMsg(msg, ms=1000){
  resultBox.textContent = msg;
  setTimeout(()=>{ resultBox.textContent = 'å°šæœªæ‰«ç '; }, ms);
}

/* åˆå§‹åŒ– Quagga å¹¶å¼€å§‹æ‘„åƒå¤´ */
function startScan(){
  if(scanning) return;
  // Quagga é…ç½®
  const config = {
    inputStream: {
      type: "LiveStream",
      target: videoWrap, // DOM element
      constraints: {
        facingMode: "environment",
        width: { min: 320, ideal: 1280 },
        height: { min: 240, ideal: 720 },
      }
    },
    locator: {
      halfSample: true,
      patchSize: "medium"
    },
    numOfWorkers: navigator.hardwareConcurrency ? Math.max(1, navigator.hardwareConcurrency -1) : 2,
    decoder: {
      readers: [
        "ean_reader",
        "ean_8_reader",
        "upc_reader",
        "upc_e_reader",
        "code_128_reader",
        "code_39_reader",
        "code_93_reader"
      ]
    },
    locate: true
  };

  // å¦‚æœ Quagga å·²ç»åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢
  try { Quagga.stop(); } catch(e){}

  Quagga.init(config, function(err){
    if(err){
      console.error('Quagga init error', err);
      showResult('æ‘„åƒå¤´æˆ–æƒé™é—®é¢˜ï¼š' + (err.name||err.message));
      return;
    }
    Quagga.start();
    scanning = true;
    showTempMsg('æ­£åœ¨è¯†åˆ«ä¸­...');
    // ç»‘å®šæ£€æµ‹å›è°ƒ
    Quagga.offDetected(onDetected);
    Quagga.onDetected(onDetected);
  });
}

/* åœæ­¢æ‰«æ */
function stopScan(){
  try{
    Quagga.stop();
  }catch(e){}
  scanning = false;
  showTempMsg('å·²åœæ­¢æ‰«æ', 1000);
}

/* æ¡ç è¢«æ£€æµ‹åˆ°æ—¶ */
function onDetected(data){
  if(!data || !data.codeResult) return;
  const code = data.codeResult.code;
  if(!code) return;

  // é˜²æ­¢çŸ­æ—¶é—´å†…é‡å¤è§¦å‘
  if(lastDetected === code) return;
  lastDetected = code;
  setTimeout(()=> lastDetected = null, 1200);

  // æ˜¾ç¤º
  if(priceDB[code] !== undefined){
    showResult(`æ¡ç : <b>${escapeHtml(code)}</b><br>ä»·æ ¼: <b>Â¥${priceDB[code]}</b>`);
    // è‡ªåŠ¨åœæ­¢æ‰«æä¸€æ¬¡ï¼ˆå¯é€‰ï¼‰ï¼Œè‹¥æƒ³æŒç»­æ‰«æè¯·æ³¨é‡Šä¸‹é¢ä¸€è¡Œ
    // stopScan();
  } else {
    showResult(`æ¡ç : <b>${escapeHtml(code)}</b><br><span class="small muted">æ— ä»·æ ¼</span>`);
    // æ˜¾ç¤ºè¾“å…¥æ¡†
    priceInputBox.style.display = 'block';
    priceInput.value = '';
    priceInput.dataset.last = code;
    setTimeout(()=> priceInput.focus(), 200);
  }
}

/* ä¿å­˜ä»·æ ¼ */
savePriceBtn.onclick = ()=>{
  const code = priceInput.dataset.last;
  if(!code){ alert('æœªæ£€æµ‹åˆ°æ¡ç '); return; }
  const price = priceInput.value.trim();
  if(price === '' || isNaN(Number(price))){
    alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—ä»·æ ¼ï¼ˆä¾‹å¦‚ 12.50ï¼‰');
    return;
  }
  priceDB[code] = Number(price).toFixed(2);
  saveDB();
  priceInputBox.style.display = 'none';
  showResult(`æ¡ç : <b>${escapeHtml(code)}</b><br>ä»·æ ¼: <b>Â¥${priceDB[code]}</b>`);
  renderList();
};

/* å–æ¶ˆè¾“å…¥ */
cancelPriceBtn.onclick = ()=>{
  priceInputBox.style.display = 'none';
  showTempMsg('å·²å–æ¶ˆ', 800);
};

/* list / table æ¸²æŸ“ */
function renderList(filter=''){
  loadDB();
  tableBody.innerHTML = '';
  const keys = Object.keys(priceDB).sort();
  const f = (filter||'').trim();
  keys.forEach(k=>{
    if(f){
      const low = f.toLowerCase();
      if(!k.toLowerCase().includes(low) && !priceDB[k].toLowerCase?.includes(low) && !String(priceDB[k]).includes(low)) return;
    }
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent = k;
    const td2 = document.createElement('td'); td2.textContent = priceDB[k];
    const td3 = document.createElement('td');
    td3.className = 'actions';
    const editBtn = document.createElement('button'); editBtn.textContent = 'æ”¹ä»·';
    editBtn.onclick = ()=> {
      const newp = prompt('ä¿®æ”¹ä»·æ ¼ï¼ˆå…ƒï¼‰', priceDB[k]);
      if(newp === null) return;
      if(newp === '' || isNaN(Number(newp))){ alert('æ— æ•ˆä»·æ ¼'); return; }
      priceDB[k] = Number(newp).toFixed(2);
      saveDB(); renderList(filter);
    };
    const delBtn = document.createElement('button'); delBtn.textContent = 'åˆ é™¤';
    delBtn.onclick = ()=> {
      if(!confirm('ç¡®è®¤åˆ é™¤æ¡ç  ' + k + ' çš„ä»·æ ¼ï¼Ÿ')) return;
      delete priceDB[k];
      saveDB(); renderList(filter);
    };
    td3.appendChild(editBtn); td3.appendChild(delBtn);
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    tableBody.appendChild(tr);
  });
}

/* å¯¼å‡º CSV */
exportBtn.onclick = ()=>{
  loadDB();
  const keys = Object.keys(priceDB).sort();
  let csv = 'barcode,price\r\n';
  keys.forEach(k=>{
    csv += `${k},${priceDB[k]}\r\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'prices.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
};

/* å¯¼å…¥ CSVï¼ˆç®€å•è§£æï¼‰ */
importFile.onchange = (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = (evt)=>{
    try{
      const text = evt.target.result;
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
      // skip header if present
      const start = (lines[0]||'').toLowerCase().includes('barcode') ? 1 : 0;
      for(let i=start;i<lines.length;i++){
        const parts = lines[i].split(',');
        if(parts.length < 2) continue;
        const code = parts[0].trim();
        let price = parts[1].trim();
        if(price==='') continue;
        if(isNaN(Number(price))) continue;
        priceDB[code] = Number(price).toFixed(2);
      }
      saveDB();
      renderList(searchInput.value);
      showTempMsg('å¯¼å…¥å®Œæˆ',1000);
    }catch(err){
      alert('å¯¼å…¥å¤±è´¥ï¼š'+err.message);
    }
  };
  reader.readAsText(f,'utf-8');
  importFile.value = '';
};

/* æ¸…ç©º DB */
clearDbBtn.onclick = ()=>{
  if(!confirm('ç¡®è®¤æ¸…ç©ºæœ¬åœ°æ‰€æœ‰ä»·æ ¼ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤')) return;
  priceDB = {};
  saveDB();
  renderList();
  showTempMsg('å·²æ¸…ç©º',1000);
};

/* æœç´¢ */
clearSearch.onclick = ()=>{ searchInput.value=''; renderList(); };
searchInput.addEventListener('input',(e)=> renderList(e.target.value.trim()));

/* åˆ‡æ¢å†å²æ˜¾ç¤º */
listBtn.onclick = ()=>{
  if(listContainer.style.display === 'none'){
    listContainer.style.display = 'block';
    renderList(searchInput.value.trim());
  } else {
    listContainer.style.display = 'none';
  }
};

/* start/stop æŒ‰é’®ç»‘å®š */
startBtn.onclick = ()=> {
  // è¯·æ±‚æ‘„åƒå¤´æƒé™å¹¶å¯åŠ¨
  startScan();
};
stopBtn.onclick = ()=> stopScan();

/* é¡µé¢åˆå§‹åŒ– */
(function init(){
  loadDB();
  renderList();
  // åˆå§‹çŠ¶æ€ï¼šstopæŒ‰é’®å¯ç”¨æ€§ç”± scanning æ§åˆ¶ï¼ˆè¿™é‡Œåªæç¤ºï¼‰
  showResult('å°šæœªæ‰«ç ');
})();

/* è¾…åŠ©å‡½æ•° */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

/* ===== æ³¨æ„äº‹é¡¹ / è°ƒè¯•å»ºè®® =====
1) iPhone Safari å¿…é¡»é€šè¿‡ HTTPSï¼ˆGitHub Pagesï¼‰æ‰èƒ½ä½¿ç”¨æ‘„åƒå¤´ã€‚
2) è‹¥æ‘„åƒå¤´é»‘å±æˆ–è¯†åˆ«ç‡ä½ï¼Œå°è¯•ï¼š
   - åˆ‡æ¢åˆ°å…‰çº¿å……è¶³å¤„
   - ä¿æŒæ¡ç å¹³æ•´ã€å¯¹ç„¦è·ç¦»çº¦ 10-20cmï¼ˆè§†æ‘„åƒå¤´ï¼‰
   - æ…¢æ…¢ç§»åŠ¨ä½¿æ¡ç è¿›æ‰«ææ¡†
3) Quagga å¯¹ä¸€ç»´æ¡ç æ”¯æŒè¾ƒå¥½ï¼ˆEAN/UPC/Code128ï¼‰ï¼Œè‹¥æç«¯æ¨¡ç³Šå¯èƒ½è¯†åˆ«å¤±è´¥ã€‚
4) è‹¥éœ€è¦æŒç»­è‡ªåŠ¨è¯†åˆ«å¹¶è‡ªåŠ¨ä¿å­˜ï¼ˆè¿ç»­æ¨¡å¼ï¼‰ï¼Œå¯ä¿®æ”¹ onDetected å†…é€»è¾‘ï¼Œä¸è‡ªåŠ¨ stopScanã€‚
============================== */

</script>
</body>
</html>
