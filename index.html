<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ä»·æ ¼æŸ¥è¯¢ï¼ˆå…±äº«ç‰ˆï¼‰</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, Helvetica, sans-serif;
  background: #f5f5f5;
  margin: 0;
}
h2 {
  text-align: center;
  margin: 20px 0;
}
.input-box {
  width: 90%;
  max-width: 500px;
  margin: auto;
}
input, button {
  width: 100%;
  padding: 12px;
  font-size: 18px;
  margin-top: 10px;
  box-sizing: border-box;
}
button {
  background: #2d89ef;
  color: #fff;
  border: none;
  border-radius: 8px;
}
.error {
  color: red;
  text-align: center;
  margin-top: 20px;
}

/* ===== æŠ˜å ç›®å½• ===== */
.folder {
  width: 90%;
  max-width: 500px;
  margin: 20px auto;
  background: #fff;
  border-radius: 10px;
  overflow: hidden;
}
.folder-title {
  padding: 14px;
  font-size: 16px;
  font-weight: bold;
  background: #eee;
  cursor: pointer;
  text-align: center;
}
.folder-content {
  display: none;
}
.record {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  border-top: 1px solid #eee;
}
.record-actions {
  display: flex;
  gap: 6px;
}
.record-actions button {
  width: auto;
  padding: 6px 12px;
  font-size: 14px;
  border-radius: 6px;
}
.delete-btn {
  background: #e5533d;
}

/* ===== å¼¹çª— ===== */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
}
.modal-content {
  background: #fff;
  width: 90%;
  max-width: 420px;
  margin: 80px auto;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
}
.modal-content h3 {
  margin-bottom: 16px;
}

/* å·²ä¿å­˜ä»·æ ¼æ˜¾ç¤º */
.saved-price {
  color: red;
  font-weight: bold;
  font-size: 26px;
  margin: 20px 0;
}

/* æ“ä½œæŒ‰é’® */
.actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}
.actions button {
  flex: 1;
}
.cancel {
  background: #aaa;
}
.hidden {
  display: none;
}
</style>
</head>

<body>

<h2>ä»·æ ¼æŸ¥è¯¢ï¼ˆå¤šäººå…±äº«ï¼‰</h2>

<div class="input-box">
  <input id="codeInput" placeholder="è¾“å…¥å•†å“ä»£ç "/>
  <button onclick="search()">æŸ¥è¯¢</button>
</div>

<div id="msg" class="error"></div>

<!-- å·²ä¿å­˜è®°å½• -->
<div class="folder">
  <div class="folder-title" onclick="toggleFolder()">
    ğŸ“‚ å·²ä¿å­˜è®°å½•
  </div>
  <div class="folder-content" id="recordList"></div>
</div>

<!-- å¼¹çª— -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>

    <!-- å·²ä¿å­˜ä»·æ ¼ -->
    <div id="savedPrice" class="saved-price hidden"></div>

    <!-- æ–°å•†å“è¾“å…¥ -->
    <input id="priceInput" type="number" step="0.01" placeholder="è¾“å…¥ä»·æ ¼"/>

    <div class="actions">
      <button id="saveBtn" onclick="save()">ä¿å­˜</button>
      <button class="cancel" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
/* ========= Supabase ========= */
const supabase = window.supabase.createClient(
  "https://ikdxkrmpuyvkoifmfzcu.supabase.co",
  "sb_publishable_wJFKBcmGiyz4WmllVoTUfQ_HevLelwn"
);

let currentProduct = null;

/* ========= æŸ¥è¯¢ ========= */
async function search() {
  const code = document.getElementById("codeInput").value.trim();
  if (!code) return alert("è¯·è¾“å…¥å•†å“ä»£ç ");

  const { data } = await supabase
    .from("products")
    .select("*")
    .eq("code", code)
    .maybeSingle();

  currentProduct = data ?? { code };
  openModal(code, data);
}

/* ========= æ‰“å¼€å¼¹çª— ========= */
function openModal(code, data) {
  document.getElementById("modal").style.display = "block";
  document.getElementById("modalTitle").textContent = code;

  const priceInput = document.getElementById("priceInput");
  const saveBtn = document.getElementById("saveBtn");
  const savedPrice = document.getElementById("savedPrice");

  if (data) {
    // âœ… å·²ä¿å­˜ï¼šåªæ˜¾ç¤ºä»·æ ¼
    savedPrice.textContent = "Â¥ " + (data.price ?? "æœªè®¾ç½®");
    savedPrice.classList.remove("hidden");

    priceInput.classList.add("hidden");
    saveBtn.classList.add("hidden");
  } else {
    // âœ… æ–°å•†å“ï¼šæ˜¾ç¤ºè¾“å…¥æ¡†
    priceInput.value = "";
    priceInput.classList.remove("hidden");
    saveBtn.classList.remove("hidden");

    savedPrice.classList.add("hidden");
  }
}

/* ========= ä¿å­˜ ========= */
async function save() {
  const price = document.getElementById("priceInput").value;
  if (price === "") return alert("è¯·è¾“å…¥ä»·æ ¼");

  await supabase.from("products")
    .insert({ code: currentProduct.code, price });

  closeModal();
  loadRecords();
}

/* ========= å…³é—­å¼¹çª— ========= */
function closeModal() {
  document.getElementById("modal").style.display = "none";
  document.getElementById("codeInput").value = "";
}

/* ========= æŠ˜å  ========= */
function toggleFolder() {
  const el = document.getElementById("recordList");
  el.style.display = el.style.display === "block" ? "none" : "block";
}

/* ========= åŠ è½½è®°å½• ========= */
async function loadRecords() {
  const { data } = await supabase
    .from("products")
    .select("*")
    .order("created_at", { ascending: false });

  const list = document.getElementById("recordList");
  list.innerHTML = "";

  if (!data || data.length === 0) {
    list.innerHTML = "<div class='record'>æš‚æ— è®°å½•</div>";
    return;
  }

  data.forEach(p => {
    const div = document.createElement("div");
    div.className = "record";
    div.innerHTML = `
      <div>${p.code}</div>
      <div class="record-actions">
        <button onclick='edit(${JSON.stringify(p)})'>ä¿®æ”¹</button>
        <button class="delete-btn" onclick='removeProduct(${JSON.stringify(p)})'>åˆ é™¤</button>
      </div>
    `;
    list.appendChild(div);
  });
}

/* ========= ä¿®æ”¹ ========= */
function edit(p) {
  currentProduct = p;
  openModal(p.code, p);
}

/* ========= åˆ é™¤ ========= */
async function removeProduct(p) {
  if (!confirm(`ç¡®è®¤åˆ é™¤å•†å“ ${p.code} å—ï¼Ÿ`)) return;
  await supabase.from("products").delete().eq("id", p.id);
  loadRecords();
}

loadRecords();
</script>

</body>
</html>
