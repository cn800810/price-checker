<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>价格查询（共享版）</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family: Arial; background:#f5f5f5; margin:0 }
h2{text-align:center;margin-top:20px}
.input-box{width:90%;margin:10px auto;display:flex;flex-direction:column}
input,button{padding:12px;font-size:18px;border-radius:8px}
button{margin-top:10px;background:#2d89ef;color:#fff;border:none}
#openListBtn{background:#444}
.drawer{position:fixed;top:0;right:-100%;width:80%;max-width:380px;height:100%;background:#fff;transition:.3s;z-index:10}
.drawer.open{right:0}
.drawer-header{background:#333;color:#fff;padding:14px;display:flex;justify-content:space-between}
.list-area{padding:10px;overflow-y:auto;height:calc(100% - 120px)}
.item{display:flex;align-items:center;border-bottom:1px solid #eee;padding:10px}
.thumb{width:55px;height:55px;background:#ddd;margin-right:10px;object-fit:cover}
.overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center}
.modal{background:#fff;padding:20px;border-radius:12px;width:90%;max-width:420px;position:relative}
.close-btn{position:absolute;right:10px;top:10px}
#modalImage{max-width:260px;display:none;margin:10px auto}
#modalPrice{font-size:30px;color:green}
</style>
</head>

<body>

<h2>价格查询（多人共享）</h2>

<div class="input-box">
  <input id="codeInput" placeholder="输入商品代码" />
  <button onclick="doSearch()">查询</button>
  <button id="openListBtn">商品列表</button>
</div>

<div id="drawer" class="drawer">
  <div class="drawer-header">
    <span>商品列表</span>
    <span onclick="drawer.classList.remove('open')">关闭</span>
  </div>
  <div class="list-area" id="listArea"></div>
</div>

<div id="overlay" class="overlay">
  <div class="modal">
    <button class="close-btn" onclick="overlay.style.display='none'">X</button>
    <h3 id="modalCode"></h3>
    < img id="modalImage">
    <div id="modalPrice"></div>
    <input id="priceInput" placeholder="输入价格">
    <button onclick="savePrice()">保存</button>
  </div>
</div>

<script>
/* ===== Supabase 配置 ===== */
const SUPABASE_URL = "https://ikdxkrmpuyvkoifmfzcu.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_wJFKBcmGiyz4WmllVoTUfQ_HevLelwn";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== DOM ===== */
const drawer = document.getElementById("drawer");
const listArea = document.getElementById("listArea");
const overlay = document.getElementById("overlay");
const modalCode = document.getElementById("modalCode");
const modalPrice = document.getElementById("modalPrice");
const priceInput = document.getElementById("priceInput");
const modalImage = document.getElementById("modalImage");

document.getElementById("openListBtn").onclick = loadList;

/* ===== 查询 ===== */
async function doSearch(){
  const code = codeInput.value.trim();
  if(!code) return alert("请输入商品代码");

  const { data } = await supabase
    .from("products")
    .select("*")
    .eq("code", code)
    .single();

  openOverlay(code, data);
}

/* ===== 弹窗 ===== */
function openOverlay(code, data){
  modalCode.innerText = "商品：" + code;
  priceInput.value = data?.price || "";
  modalPrice.innerText = data?.price ? "¥"+data.price : "未设置";
  modalImage.style.display = data?.image_url ? "block" : "none";
  modalImage.src = data?.image_url || "";
  overlay.style.display = "flex";
}

/* ===== 保存 ===== */
async function savePrice(){
  const code = modalCode.innerText.replace("商品：","");
  const price = priceInput.value;

  await supabase
    .from("products")
    .upsert({ code, price });

  alert("已保存");
  overlay.style.display="none";
  loadList();
}

/* ===== 列表 ===== */
async function loadList(){
  drawer.classList.add("open");
  listArea.innerHTML="";

  const { data } = await supabase
    .from("products")
    .select("*")
    .order("code");

  data.forEach(item=>{
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`<div>${item.code}</div><div>¥${item.price||"-"}</div>`;
    d.onclick=()=>openOverlay(item.code,item);
    listArea.appendChild(d);
  });
}
</script>

</body>
</html>
