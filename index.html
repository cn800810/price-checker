<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>价格查询</title>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f5f5f5;
}

/* 标题 */
h2 {
    text-align: center;
    margin-top: 20px;
}

/* 输入区域 */
.input-box {
    width: 90%;
    margin: 10px auto;
    display: flex;
    flex-direction: column;
}

input {
    padding: 12px;
    font-size: 18px;
    border-radius: 8px;
    border: 1px solid #aaa;
}

button {
    padding: 14px;
    margin-top: 10px;
    font-size: 18px;
    background: #2d89ef;
    color: white;
    border: none;
    border-radius: 8px;
}

#openListBtn {
    background: #444;
}

/* ======= 抽屉列表 ======= */
.drawer {
    width: 80%;
    max-width: 380px;
    background: white;
    height: 100%;
    position: fixed;
    top: 0;
    right: -100%;
    transition: 0.35s;
    z-index: 20;
    box-shadow: -2px 0 8px rgba(0,0,0,0.25);
}

.drawer.open {
    right: 0;
}

.drawer-header {
    padding: 14px;
    background: #333;
    color: white;
    font-size: 20px;
    display: flex;
    justify-content: space-between;
}

#searchList {
    padding: 12px;
    width: 80%;
    font-size: 16px;
}

.list-area {
    height: calc(100% - 140px);
    overflow-y: auto;
    padding: 10px;
}

.item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
}

.thumb {
    width: 55px;
    height: 55px;
    background: #ccc;
    object-fit: cover;
    margin-right: 10px;
}

.item-info {
    flex: 1;
}

.item-code {
    font-size: 16px;
    font-weight: bold;
}

.item-price {
    font-size: 14px;
    color: green;
}

.item-actions {
    display: flex;
    gap: 6px;
}

.small-btn {
    padding: 6px 10px;
    font-size: 14px;
    background: #2d89ef;
    color: white;
    border: none;
    border-radius: 6px;
}

/* ======= 弹窗 ======= */
.overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.55);
    justify-content: center;
    align-items: center;
    z-index: 50;
}

.modal {
    width: 90%;
    max-width: 420px;
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    position: relative;
}

/* 关闭按钮 */
.close-btn {
    position: absolute;
    right: 14px;
    top: 12px;
    background: #999;
    padding: 4px 10px;
    border-radius: 8px;
}

/* 价格显示 */
#modalPrice {
    font-size: 32px;
    margin: 12px 0;
    color: green;
}

/* 未找到提示 */
#noPrice {
    font-size: 20px;
    color: red;
    margin: 10px 0;
}

/* 图片 */
#modalImage {
    width: 80%;
    max-width: 260px;
    margin: 10px auto;
    display: none;
    border-radius: 10px;
}

/* 输入价格 */
#priceInput {
    width: 90%;
    margin: 10px auto;
    padding: 10px;
    font-size: 18px;
}

/* 上传图片按钮 */
#imgUploadBtn {
    background: #ff9800;
}

/* 保存提示 */
#saveMsg {
    color: green;
    font-size: 18px;
    margin-top: 10px;
    display: none;
}
</style>
</head>

<body>

<h2>价格查询</h2>
<div style="text-align:center; color:red; margin-top:-10px;">（请输入后5位数）</div>

<div class="input-box">
    <input id="codeInput" placeholder="输入商品代码" />
    <button onclick="doSearch()">查询价格</button>
    <button id="openListBtn">已保存商品列表</button>
</div>

<!-- 抽屉列表 -->
<div id="drawer" class="drawer">
    <div class="drawer-header">
        <span>商品列表</span>
        <span id="closeListBtn" style="cursor:pointer;">关闭</span>
    </div>
    <div style="display:flex; padding:10px; gap:10px;">
        <input id="searchList" placeholder="搜索代码或价格" />
        <button id="clearSearchList">清空</button>
    </div>
    <div class="list-area" id="listArea"></div>
</div>

<!-- 弹窗 -->
<div id="overlay" class="overlay">
    <div class="modal">
        <button class="close-btn" onclick="closeOverlay()">X</button>

        <h2 id="modalTitle"></h2>
        <div id="modalCode"></div>

        <img id="modalImage" />

        <div id="modalPrice"></div>
        <div id="noPrice"></div>

        <input id="priceInput" type="number" placeholder="输入价格（支持两位小数）" />

        <button id="imgUploadBtn">上传图片</button>

        <button class="save-btn" onclick="overlaySave()">保存</button>
        <div id="saveMsg">已保存！</div>
    </div>
</div>


<script>
/* ========== 数据模型 ========== */
const LS_KEY = "priceDB_v3";
let db = {};

function loadDB(){
    try{
        db = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
    }catch(e){
        db = {};
    }
}

function saveDB(){
    localStorage.setItem(LS_KEY, JSON.stringify(db));
}

loadDB();

/* ====== 控件 ====== */
const drawer = document.getElementById("drawer");
const openListBtn = document.getElementById("openListBtn");
const closeListBtn = document.getElementById("closeListBtn");
const listArea = document.getElementById("listArea");
const searchList = document.getElementById("searchList");
const clearSearchList = document.getElementById("clearSearchList");

const overlay = document.getElementById("overlay");
const modalTitle = document.getElementById("modalTitle");
const modalCode = document.getElementById("modalCode");
const modalPrice = document.getElementById("modalPrice");
const noPrice = document.getElementById("noPrice");
const modalImage = document.getElementById("modalImage");
const priceInput = document.getElementById("priceInput");
const saveMsg = document.getElementById("saveMsg");

const imgUploadBtn = document.getElementById("imgUploadBtn");
const imgFileInput = document.createElement("input");
imgFileInput.type = "file";
imgFileInput.accept = "image/*";
imgFileInput.style.display = "none";
document.body.appendChild(imgFileInput);

imgUploadBtn.addEventListener("click", ()=> imgFileInput.click());

imgFileInput.addEventListener("change", e=>{
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ev=>{
        modalImage.src = ev.target.result;
        modalImage.style.display = "block";
        modalImage.dataset.temp = ev.target.result;
    };
    r.readAsDataURL(f);
    e.target.value = "";
});

/* ====== 列表功能 ====== */
openListBtn.onclick = ()=>{
    drawer.classList.add("open");
    renderList();
};

closeListBtn.onclick = ()=> drawer.classList.remove("open");

clearSearchList.onclick = ()=>{
    searchList.value = "";
    renderList();
};

searchList.oninput = ()=> renderList(searchList.value.trim());

function renderList(filter=""){
    loadDB();
    listArea.innerHTML = "";
    const keys = Object.keys(db).sort();

    if(keys.length === 0){
        listArea.innerHTML = `<div style="padding:20px;text-align:center;color:#888">暂无商品</div>`;
        return;
    }

    keys.forEach(code=>{
        const item = db[code];

        if(filter){
            let f = filter.toLowerCase();
            if(!code.includes(f) && !(item.price+"").includes(f)) return;
        }

        const row = document.createElement("div");
        row.className = "item";

        const img = document.createElement("img");
        img.className = "thumb";
        img.src = item.image || "";
        if(!item.image) img.style.background = "#eee";

        const info = document.createElement("div");
        info.className = "item-info";

        const c = document.createElement("div");
        c.className = "item-code";
        c.innerText = code;

        const p = document.createElement("div");
        p.className = "item-price";
        p.innerText = item.price ? ("¥"+item.price) : "未设置";

        info.appendChild(c);
        info.appendChild(p);

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const viewBtn = document.createElement("button");
        viewBtn.className = "small-btn";
        viewBtn.innerText = "查看";
        viewBtn.onclick = ()=> openOverlay(code);

        const delBtn = document.createElement("button");
        delBtn.className = "small-btn";
        delBtn.innerText = "删除";
        delBtn.onclick = ()=>{
            if(confirm("确认删除 "+code+" ?")){
                delete db[code];
                saveDB();
                renderList(filter);
            }
        };

        actions.appendChild(viewBtn);
        actions.appendChild(delBtn);

        row.appendChild(img);
        row.appendChild(info);
        row.appendChild(actions);
        listArea.appendChild(row);
    });
}

/* ====== 查询 ====== */
function doSearch(){
    const code = document.getElementById("codeInput").value.trim();
    if(!code){
        alert("请输入商品代码");
        return;
    }
    openOverlay(code);
}

/* ====== 打开弹窗 ====== */
function openOverlay(code){
    loadDB();
    let rec = db[code];

    overlay.style.display = "flex";

    modalCode.innerText = "商品代码：" + code;
    modalCode.dataset.code = code;

    if(rec && rec.price){
        modalTitle.innerText = "查询成功";
        modalPrice.innerText = "¥"+rec.price;
        modalPrice.style.display = "block";
        noPrice.style.display = "none";
        priceInput.value = rec.price;
    } else {
        modalTitle.innerText = "未找到价格";
        modalPrice.style.display = "none";
        noPrice.style.display = "block";
        priceInput.value = "";
    }

    // 图片
    if(rec && rec.image){
        modalImage.src = rec.image;
        modalImage.style.display = "block";
        delete modalImage.dataset.temp;
    } else {
        modalImage.style.display = "none";
        modalImage.src = "";
        delete modalImage.dataset.temp;
    }

    saveMsg.style.display = "none";
}

/* ====== 关闭弹窗 ====== */
function closeOverlay(){
    overlay.style.display = "none";
}

/* ====== 保存 ====== */
function overlaySave(){
    const code = modalCode.dataset.code;
    let price = priceInput.value.trim();

    if(!price || isNaN(price)){
        alert("请输入正确价格");
        return;
    }

    price = parseFloat(price).toFixed(2);

    loadDB();
    if(!db[code]) db[code] = { price:null, image:null };

    db[code].price = price;

    if(modalImage.dataset.temp){
        db[code].image = modalImage.dataset.temp;
    }

    saveDB();
    saveMsg.style.display = "block";
    modalPrice.innerText = "¥"+price;
    modalPrice.style.display = "block";
    noPrice.style.display = "none";

    renderList(searchList.value.trim());
}
</script>

</body>
</html>
