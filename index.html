<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ä»·æ ¼æŸ¥è¯¢</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, Helvetica, sans-serif;
  background:#f5f5f5;
  margin:0;
  text-align:center;
}

h2 {
  margin:20px 0;
  color:#2d89ef;
  font-family: "VillaMassiel", Arial, Helvetica, sans-serif;
}

.input-box {
  width:90%;
  max-width:420px;
  margin:auto;
}

input, button {
  width:100%;
  padding:12px;
  font-size:18px;
  margin-top:10px;
  box-sizing:border-box;
}

button {
  background:#2d89ef;
  color:#fff;
  border:none;
  border-radius:8px;
}

#toggleList {
  background:#444;
  margin-top:15px;
}

#list {
  display:none;
  width:90%;
  max-width:520px;
  margin:20px auto;
  text-align:left;
}

.item {
  background:#fff;
  padding:12px;
  margin-bottom:10px;
  border-radius:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.code { font-weight:bold; }
.price { color:red; font-weight:bold; }

.actions button {
  font-size:14px;
  padding:6px 10px;
  margin-left:5px;
}

/* ===== å¼¹çª— ===== */
#overlay {
  display:none;
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
}

#modal {
  background:#fff;
  width:90%;
  max-width:380px;
  padding:20px;
  border-radius:12px;
}

#modalCode {
  font-size:22px;
  margin-bottom:10px;
}

#modalPrice {
  font-size:28px;
  font-weight:bold;
  color:red;
}

#modalImg {
  width:80%;
  margin-top:10px;
  border-radius:10px;
  display:none;
}

.close-btn {
  background:#999;
  margin-top:10px;
}
</style>
</head>

<body>

<h2>ä»·æ ¼æŸ¥è¯¢ï¼ˆå¤šäººå…±äº«ï¼‰</h2>

<div class="input-box">
  <input id="codeInput" placeholder="è¾“å…¥å•†å“ä»£ç "/>
  <button onclick="search()">æŸ¥è¯¢</button>
  <button id="toggleList" onclick="toggleList()">ğŸ“‚ å·²ä¿å­˜å•†å“</button>
</div>

<div id="list"></div>

<!-- å¼¹çª— -->
<div id="overlay">
  <div id="modal">
    <div id="modalCode"></div>
    <div id="modalPrice"></div>
    < img id="modalImg">

    <input id="priceInput" type="number" placeholder="è¾“å…¥ä»·æ ¼" style="display:none;">
    <input id="imgInput" type="file" accept="image/*" style="display:none;">

    <button id="saveBtn" onclick="saveNew()" style="display:none;">ä¿å­˜</button>
    <button class="close-btn" onclick="closeModal()">å…³é—­</button>
  </div>
</div>

<script>
/* ===== Supabase ===== */
const supabase = window.supabase.createClient(
  "https://ikdxkrmpuyvkoifmfzcu.supabase.co",
  "sb_publishable_wJFKBcmGiyz4WmllVoTUfQ_HevLelwn"
);

/* ===== DOM ç»‘å®šï¼ˆå…³é”®ä¿®å¤ç‚¹ï¼‰===== */
const overlay = document.getElementById("overlay");
const modalCode = document.getElementById("modalCode");
const modalPrice = document.getElementById("modalPrice");
const modalImg = document.getElementById("modalImg");
const priceInput = document.getElementById("priceInput");
const imgInput = document.getElementById("imgInput");
const saveBtn = document.getElementById("saveBtn");
const codeInput = document.getElementById("codeInput");
const list = document.getElementById("list");

let currentCode = "";
let listOpen = false;

/* ===== æŸ¥è¯¢ ===== */
async function search(){
  const code = codeInput.value.trim();
  if(!code) return alert("è¯·è¾“å…¥å•†å“ä»£ç ");
  currentCode = code;

  const { data } = await supabase
    .from("products")
    .select("*")
    .eq("code", code)
    .maybeSingle();

  openModal(data);
}

/* ===== å¼¹çª— ===== */
function openModal(data){
  overlay.style.display="flex";
  modalCode.innerText = currentCode;

  if(data){
    modalCode.style.color="green";
    modalPrice.innerText = "Â¥ " + data.price;

    if(data.image_url){
      modalImg.src = data.image_url;
      modalImg.style.display="block";
    } else {
      modalImg.style.display="none";
    }

    priceInput.style.display="none";
    imgInput.style.display="none";
    saveBtn.style.display="none";
  }else{
    modalCode.style.color="#000";
    modalPrice.innerText = "æœªå½•å…¥";
    modalImg.style.display="none";

    priceInput.value="";
    imgInput.value="";
    priceInput.style.display="block";
    imgInput.style.display="block";
    saveBtn.style.display="block";
  }
}

function closeModal(){
  overlay.style.display="none";
  codeInput.value="";
}

/* ===== ä¿å­˜ ===== */
async function saveNew(){
  const price = priceInput.value;
  if(!price) return alert("è¯·è¾“å…¥ä»·æ ¼");

  let image_url = null;

  if(imgInput.files[0]){
    const file = imgInput.files[0];
    const path = Date.now()+"_"+file.name;

    const { error } = await supabase
      .storage.from("product-images")
      .upload(path, file);

    if(!error){
      image_url = supabase
        .storage.from("product-images")
        .getPublicUrl(path).data.publicUrl;
    }
  }

  await supabase.from("products").insert({
    code: currentCode,
    price,
    image_url
  });

  closeModal();
  loadList();
}

/* ===== ç›®å½• ===== */
function toggleList(){
  listOpen = !listOpen;
  list.style.display = listOpen ? "block" : "none";
  if(listOpen) loadList();
}

async function loadList(){
  const { data } = await supabase
    .from("products")
    .select("*")
    .order("created_at",{ascending:false});

  list.innerHTML="";
  data.forEach(p=>{
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`
      <div style="display:flex;align-items:center;">
        ${p.image_url ? `< img src="${p.image_url}" style="width:40px;height:40px;border-radius:6px;margin-right:8px;">` : ""}
        <div>
          <div class="code">${p.code}</div>
          <div class="price">Â¥ ${p.price}</div>
        </div>
      </div>
      <div class="actions">
        <button onclick="edit('${p.code}')">ä¿®æ”¹</button>
        <button onclick="del('${p.code}')">åˆ é™¤</button>
      </div>
    `;
    list.appendChild(d);
  });
}

function edit(code){
  codeInput.value = code;
  search();
}

async function del(code){
  if(confirm("ç¡®è®¤åˆ é™¤ "+code+" ?")){
    await supabase.from("products").delete().eq("code",code);
    loadList();
  }
}
</script>

</body>
</html>
