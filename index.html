<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>价格查询</title>

<!-- Supabase SDK -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
/* ===== 原样保留你的 CSS（未删减） ===== */
body { font-family: Arial; background:#f5f5f5; margin:0 }
h2 { text-align:center; margin-top:20px }
.input-box{ width:90%; margin:10px auto; display:flex; flex-direction:column }
input{ padding:12px; font-size:18px; border-radius:8px; border:1px solid #aaa }
button{ padding:14px; margin-top:10px; font-size:18px; background:#2d89ef; color:white; border:none; border-radius:8px }
#openListBtn{ background:#444 }
.drawer{ width:80%; max-width:380px; background:white; height:100%; position:fixed; top:0; right:-100%; transition:.35s; z-index:20 }
.drawer.open{ right:0 }
.drawer-header{ padding:14px; background:#333; color:white; display:flex; justify-content:space-between }
.list-area{ padding:10px; height:calc(100% - 120px); overflow:auto }
.item{ display:flex; align-items:center; border-bottom:1px solid #eee; padding:10px }
.thumb{ width:55px; height:55px; background:#ccc; margin-right:10px; object-fit:cover }
.item-info{ flex:1 }
.item-code{ font-weight:bold }
.item-price{ color:green }
.item-actions button{ font-size:14px; padding:6px 10px }
.overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); justify-content:center; align-items:center; z-index:50 }
.modal{ background:white; padding:20px; border-radius:12px; width:90%; max-width:420px; position:relative }
.close-btn{ position:absolute; right:10px; top:10px }
#modalImage{ width:80%; max-width:260px; display:none; border-radius:10px }
</style>
</head>

<body>

<h2>价格查询</h2>

<div class="input-box">
  <input id="codeInput" placeholder="输入商品代码" />
  <button onclick="doSearch()">查询</button>
  <button id="openListBtn">商品列表</button>
</div>

<div id="drawer" class="drawer">
  <div class="drawer-header">
    <span>商品列表</span>
    <span onclick="drawer.classList.remove('open')" style="cursor:pointer">关闭</span>
  </div>
  <div class="list-area" id="listArea"></div>
</div>

<div id="overlay" class="overlay">
  <div class="modal">
    <button class="close-btn" onclick="overlay.style.display='none'">X</button>
    <h2 id="modalTitle"></h2>
    <div id="modalCode"></div>
    < img id="modalImage">
    <div id="modalPrice"></div>
    <input id="priceInput" placeholder="输入价格">
    <button onclick="saveProduct()">保存</button>
  </div>
</div>

<script>
/* ===== Supabase 初始化 ===== */
const supabase = supabaseJs.createClient(
  'https://ikdxkrmpuyvkoifmfzcu.supabase.co',
  'sb_publishable_WJFKBCmGiyz4Wm1lVoTUfQ_HevLelwn'
)

const drawer = document.getElementById('drawer')
const listArea = document.getElementById('listArea')
const overlay = document.getElementById('overlay')

/* ===== 查询 ===== */
async function doSearch(){
  const code = codeInput.value.trim()
  if(!code) return alert('请输入代码')

  const { data } = await supabase
    .from('products')
    .select('*')
    .eq('code', code)
    .single()

  openOverlay(code, data)
}

/* ===== 弹窗 ===== */
function openOverlay(code, data){
  overlay.style.display = 'flex'
  modalCode.innerText = '商品代码：' + code
  modalCode.dataset.code = code

  if(data){
    modalTitle.innerText = '查询成功'
    modalPrice.innerText = '¥' + data.price
    priceInput.value = data.price
    if(data.image){
      modalImage.src = data.image
      modalImage.style.display = 'block'
    }
  }else{
    modalTitle.innerText = '未录入，新增商品'
    modalPrice.innerText = ''
    priceInput.value = ''
    modalImage.style.display = 'none'
  }
}

/* ===== 保存（新增 / 更新） ===== */
async function saveProduct(){
  const code = modalCode.dataset.code
  const price = parseFloat(priceInput.value)
  if(isNaN(price)) return alert('价格错误')

  await supabase.from('products').upsert({
    code,
    price
  })

  overlay.style.display = 'none'
  loadList()
}

/* ===== 列表 ===== */
openListBtn.onclick = ()=>{
  drawer.classList.add('open')
  loadList()
}

async function loadList(){
  listArea.innerHTML = '加载中...'
  const { data } = await supabase
    .from('products')
    .select('*')
    .order('created_at', { ascending:false })

  listArea.innerHTML = ''
  data.forEach(p=>{
    const d = document.createElement('div')
    d.className = 'item'
    d.innerHTML = `
      <div class="item-info">
        <div class="item-code">${p.code}</div>
        <div class="item-price">¥${p.price}</div>
      </div>
      <button onclick="deleteProduct('${p.code}')">删除</button>
    `
    listArea.appendChild(d)
  })
}

/* ===== 删除 ===== */
async function deleteProduct(code){
  if(!confirm('确认删除 '+code+' ?')) return
  await supabase.from('products').delete().eq('code', code)
  loadList()
}
</script>

</body>
</html>
