<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>商品价格查询</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial;
  background:#f5f5f5;
  margin:0;
  padding:20px;
}
h1 { text-align:center; }
.card {
  background:#fff;
  border-radius:12px;
  padding:16px;
  margin-top:20px;
}
input, button {
  width:100%;
  padding:12px;
  margin-top:10px;
  font-size:16px;
}
button {
  background:#1677ff;
  color:#fff;
  border:none;
  border-radius:8px;
}
button.gray { background:#666; }
.price {
  font-size:32px;
  color:green;
  text-align:center;
}
img {
  max-width:100%;
  border-radius:10px;
  margin-top:10px;
}
.list-item {
  border-bottom:1px solid #eee;
  padding:10px 0;
}
</style>
</head>

<body>

<h1>商品价格查询</h1>

<input id="codeInput" placeholder="输入商品编码">
<button onclick="query()">查询</button>

<div id="result"></div>

<div class="card">
  <h3>商品目录</h3>
  <div id="list"></div>
</div>

<script>
const supabase = supabase.createClient(
  "https://ikdxkrmpuyvkoifmfzcu.supabase.co",
  "sb_publishable_wJFKBcmGiyz4WmllVoTUfQ_HevLelwn"
);

async function query() {
  const code = codeInput.value.trim();
  if (!code) return;

  const { data } = await supabase
    .from("products")
    .select("*")
    .eq("code", code)
    .single();

  if (!data) {
    result.innerHTML = renderForm(code);
  } else {
    result.innerHTML = renderForm(code, data);
  }
}

function renderForm(code, data={}) {
  return `
  <div class="card">
    <div>商品代码：${code}</div>
    ${data.image_url ? `< img src="${data.image_url}">` : ""}
    <div class="price">${data.price ? "¥"+data.price : ""}</div>

    <input id="priceInput" value="${data.price||""}" placeholder="输入价格">
    <input type="file" id="imgInput">

    <button onclick="save('${code}', ${data.id||null})">保存</button>
    ${data.id ? `<button class="gray" onclick="del(${data.id})">删除</button>` : ""}
  </div>`;
}

async function save(code, id) {
  const price = priceInput.value;
  let image_url = null;

  const file = imgInput.files[0];
  if (file) {
    const path = Date.now()+"_"+file.name;
    await supabase.storage.from("images").upload(path, file);
    image_url = supabase.storage.from("images").getPublicUrl(path).data.publicUrl;
  }

  if (id) {
    await supabase.from("products").update({price, image_url}).eq("id", id);
  } else {
    await supabase.from("products").insert({code, price, image_url});
  }
  query();
  loadList();
}

async function del(id) {
  if (!confirm("确认删除？")) return;
  await supabase.from("products").delete().eq("id", id);
  result.innerHTML="";
  loadList();
}

async function loadList() {
  const { data } = await supabase.from("products").select("*").order("created_at",{ascending:false});
  list.innerHTML = data.map(d=>`
    <div class="list-item">
      ${d.code} — ¥${d.price||""}
    </div>`).join("");
}
loadList();
</script>

</body>
</html>
