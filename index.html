<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>价格查询</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial; padding: 30px; }
    input, button { padding: 8px; font-size: 16px; }
    dialog { border: none; border-radius: 8px; padding: 20px; width: 320px; }
    img { max-width: 100%; margin-top: 10px; }
  </style>
</head>
<body>

<h2>价格查询</h2>

<input id="codeInput" placeholder="输入商品代码" />
<button onclick="checkCode()">查询</button>

<dialog id="productDialog">
  <h3 id="dialogTitle"></h3>

  <label>价格：</label><br />
  <input id="priceInput" type="number" step="0.01" /><br /><br />

  <label>图片：</label><br />
  <input id="imageInput" type="file" accept="image/*" /><br />

  < img id="preview" />

  <br /><br />
  <button onclick="saveProduct()">保存</button>
  <button onclick="closeDialog()">取消</button>
</dialog>

<script>
/* 1️⃣ Supabase 初始化（修复你之前的报错） */
const supabase = window.supabase.createClient(
  'https://你的-project-id.supabase.co',
  '你的 anon public key'
)

let currentProduct = null

/* 2️⃣ 查询商品 */
async function checkCode() {
  const code = document.getElementById('codeInput').value.trim()
  if (!code) return alert('请输入商品代码')

  const { data } = await supabase
    .from('products')
    .select('*')
    .eq('code', code)
    .single()

  currentProduct = data || { code }

  openDialog(!!data)
}

/* 3️⃣ 打开弹窗 */
function openDialog(exists) {
  const dialog = document.getElementById('productDialog')
  document.getElementById('dialogTitle').innerText =
    exists ? '商品已存在（可修改）' : '新商品（请输入价格和图片）'

  document.getElementById('priceInput').value = currentProduct.price || ''
  document.getElementById('preview').src = currentProduct.image_url || ''

  dialog.showModal()
}

/* 4️⃣ 保存（新增 / 修改 通用） */
async function saveProduct() {
  const price = document.getElementById('priceInput').value
  const file = document.getElementById('imageInput').files[0]

  let imageUrl = currentProduct.image_url || null

  if (file) {
    const filePath = `${Date.now()}_${file.name}`
    await supabase.storage
      .from('product-images')
      .upload(filePath, file, { upsert: true })

    const { data } = supabase
      .storage
      .from('product-images')
      .getPublicUrl(filePath)

    imageUrl = data.publicUrl
  }

  await supabase.from('products').upsert({
    code: currentProduct.code,
    price,
    image_url: imageUrl
  })

  alert('保存成功')
  closeDialog()
}

/* 5️⃣ 关闭弹窗 */
function closeDialog() {
  document.getElementById('productDialog').close()
  document.getElementById('imageInput').value = ''
}
</script>

</body>
</html>
