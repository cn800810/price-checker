<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>价格查询（多人共享）</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { font-family: Arial; background:#f5f5f5; margin:0 }
h2 { text-align:center; margin:20px }
input,button { width:100%; padding:12px; font-size:16px; margin-top:10px }
button { background:#2d89ef; color:#fff; border:none; border-radius:6px }

.container { width:90%; max-width:600px; margin:auto }
.item { background:#fff; padding:10px; border-radius:6px; margin:6px 0; cursor:pointer }
.price { color:green }

.group-title { font-weight:bold; margin-top:10px; cursor:pointer }
.group-items { margin-left:10px }

.modal {
  position:fixed; inset:0; background:rgba(0,0,0,.5);
  display:none; justify-content:center; align-items:center;
}
.modal-box {
  background:#fff; padding:20px; width:90%; max-width:400px; border-radius:8px
}
img { max-width:100%; margin-top:10px }
.danger { background:#d9534f }
.gray { background:#aaa }
</style>
</head>

<body>

<h2>价格查询（多人共享）</h2>

<div class="container">
  <input id="codeInput" placeholder="输入商品代码" />
  <button onclick="handleCode()">查询</button>
  <div id="list"></div>
</div>

<!-- 弹窗 -->
<div id="modal" class="modal">
  <div class="modal-box">
    <h3 id="modalTitle"></h3>

    <input id="priceInput" placeholder="价格" />
    <input id="imgInput" type="file" accept="image/*" />

    < img id="preview" />

    <button onclick="save()">保存 / 修改</button>
    <button class="danger" onclick="askDelete()">删除</button>
    <button class="gray" onclick="closeModal()">取消</button>
  </div>
</div>

<script>
const supabase = supabase.createClient(
  "https://ikdxkrmpuyvkoifmfzcu.supabase.co",
  "sb_publishable_wJFKBcmGiyz4WmllVoTUfQ_HevLelwn"
)

let current = null

/* 查询 */
async function handleCode() {
  const code = codeInput.value.trim()
  if (!code) return alert("请输入商品代码")

  const { data } = await supabase
    .from("products")
    .select("*")
    .eq("code", code)
    .maybeSingle()

  current = data
  openModal(code, data)
}

/* 打开弹窗 */
function openModal(code, data) {
  modal.style.display = "flex"
  modalTitle.textContent = data ? "修改商品" : "新商品"
  priceInput.value = data?.price ?? ""
  preview.src = data?.image_url ?? ""
}

/* 关闭 */
function closeModal() {
  modal.style.display = "none"
  current = null
}

/* 保存 / 修改 */
async function save() {
  const code = codeInput.value.trim()
  const price = priceInput.value.trim()
  let imageUrl = current?.image_url

  if (imgInput.files[0]) {
    const file = imgInput.files[0]
    const path = `${code}-${Date.now()}`
    await supabase.storage.from("product-images").upload(path, file)
    imageUrl = supabase.storage.from("product-images").getPublicUrl(path).data.publicUrl
  }

  if (current) {
    await supabase.from("products")
      .update({ price, image_url: imageUrl })
      .eq("code", code)
  } else {
    await supabase.from("products")
      .insert({ code, price, image_url: imageUrl })
  }

  closeModal()
  loadList()
}

/* 删除（二次确认） */
async function askDelete() {
  if (!current) return
  if (!confirm("⚠️ 确认要删除该商品吗？此操作不可恢复")) return

  await supabase.from("products")
    .delete()
    .eq("code", current.code)

  closeModal()
  loadList()
}

/* 商品列表（折叠） */
async function loadList() {
  const { data } = await supabase.from("products").select("*").order("code")
  const groups = {}

  data.forEach(p => {
    const k = isNaN(p.code[0]) ? p.code[0].toUpperCase() : "数字"
    if (!groups[k]) groups[k] = []
    groups[k].push(p)
  })

  list.innerHTML = ""
  Object.keys(groups).sort().forEach(g => {
    const div = document.createElement("div")
    div.innerHTML = `
      <div class="group-title" onclick="toggle('${g}')">▶ ${g}</div>
      <div id="g-${g}" class="group-items" style="display:none">
        ${groups[g].map(p => `
          <div class="item" onclick="select('${p.code}')">
            ${p.code}
            <span class="price">¥ ${p.price ?? "未设置"}</span>
          </div>
        `).join("")}
      </div>
    `
    list.appendChild(div)
  })
}

function toggle(g) {
  const el = document.getElementById("g-"+g)
  el.style.display = el.style.display === "none" ? "block" : "none"
}

function select(code) {
  codeInput.value = code
  handleCode()
}

loadList()
</script>

</body>
</html>
