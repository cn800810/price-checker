<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ä»·æ ¼æŸ¥è¯¢</title>

<!-- å¼•å…¥ ZXing è§£ç åº“ -->
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>

<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 20px;
}

button {
    font-size: 18px;
    padding: 12px 20px;
    margin: 10px;
}

#video {
    width: 100%;
    max-width: 350px;
    border: 2px solid #333;
    margin-top: 15px;
}

#priceBox {
    display: none;
    margin-top: 20px;
}
</style>
</head>

<body>

<h2>ğŸ“± å•†å“ä»·æ ¼æŸ¥è¯¢å·¥å…·</h2>

<button id="startScan">å¼€å§‹æ‰«ç </button>

<video id="video" autoplay playsinline></video>

<h3 id="result">å°šæœªæ‰«ç </h3>

<div id="priceBox">
    <p>æ‰«æç»“æœï¼š <b id="codeText"></b></p>
    <p>ä»·æ ¼ï¼š <input id="priceInput" type="number" placeholder="è¯·è¾“å…¥ä»·æ ¼"> å…ƒ</p>
    <button id="savePrice">ä¿å­˜ä»·æ ¼</button>
</div>

<script>
const codeReader = new ZXing.BrowserMultiFormatReader();
let currentCode = "";
let streamStarted = false;

document.getElementById("startScan").addEventListener("click", async () => {
    const video = document.getElementById("video");

    if (!streamStarted) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" }
            });
            video.srcObject = stream;
            streamStarted = true;
        } catch (err) {
            alert("æ— æ³•æ‰“å¼€æ‘„åƒå¤´ï¼š" + err);
            return;
        }
    }

    startDecoding();
});

function startDecoding() {
    codeReader.decodeFromVideoDevice(null, "video", (result, err) => {
        if (result) {
            const code = result.text;
            if (code !== currentCode) {
                currentCode = code;
                onCodeDetected(code);
            }
        }
    });
}

function onCodeDetected(code) {
    document.getElementById("result").innerText = "æ‰«ææˆåŠŸï¼š" + code;

    document.getElementById("priceBox").style.display = "block";
    document.getElementById("codeText").innerText = code;

    // è¯»å–æœ¬åœ°ä»·æ ¼
    const savedPrice = localStorage.getItem("price_" + code);
    document.getElementById("priceInput").value = savedPrice || "";
}

// ä¿å­˜ä»·æ ¼
document.getElementById("savePrice").addEventListener("click", () => {
    if (!currentCode) return;

    const price = document.getElementById("priceInput").value.trim();
    if (!price) {
        alert("è¯·è¾“å…¥ä»·æ ¼ï¼");
        return;
    }

    localStorage.setItem("price_" + currentCode, price);
    alert("ä»·æ ¼å·²ä¿å­˜ï¼");
});
</script>

</body>
</html>
