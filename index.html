<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>价格查询（多人共享）</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, Helvetica, sans-serif;
  background: #f5f5f5;
  margin: 0;
}
h2 { text-align:center; margin:20px 0; }
.box {
  width:90%; max-width:500px; margin:auto;
}
input, button {
  width:100%; padding:12px; font-size:16px;
  margin-top:10px; box-sizing:border-box;
}
button {
  background:#2d89ef; color:#fff;
  border:none; border-radius:8px;
}
#list {
  width:90%; max-width:700px;
  margin:20px auto;
}
.item {
  background:#fff; border-radius:8px;
  margin-bottom:10px; overflow:hidden;
}
.header {
  padding:12px; cursor:pointer;
  display:flex; justify-content:space-between;
  background:#eee;
}
.content { display:none; padding:12px; }
.price { color:green; font-size:18px; }
img { max-width:100%; border-radius:6px; margin-top:8px; }
.actions button {
  margin-top:6px; background:#666;
}
.delete { background:#c0392b !important; }
</style>
</head>

<body>

<h2>价格查询（多人共享）</h2>

<div class="box">
  <input id="codeInput" placeholder="商品代码">
  <input id="priceInput" placeholder="价格">
  <input id="imgInput" type="file" accept="image/*">
  <button onclick="save()">查询 / 保存</button>
</div>

<div id="list"></div>

<script>
const supabase = window.supabase.createClient(
  "https://ikdxkrmpuyvkoifmfzcu.supabase.co",
  "sb_publishable_wJFKBcmGiyz4WmllVoTUfQ_HevLelwn"
);

async function save(){
  const code = codeInput.value.trim();
  const price = priceInput.value.trim();
  const file = imgInput.files[0];
  if(!code) return alert("请输入商品代码");

  let image_url = null;

  if(file){
    const path = `${code}-${Date.now()}.${file.name.split('.').pop()}`;
    const { error } = await supabase
      .storage.from("product-images")
      .upload(path, file, { upsert:true });
    if(error) return alert("图片上传失败");

    image_url =
      `https://ikdxkrmpuyvkoifmfzcu.supabase.co/storage/v1/object/public/product-images/${path}`;
  }

  const { data } = await supabase
    .from("products")
    .select("*")
    .eq("code", code)
    .maybeSingle();

  if(data){
    await supabase.from("products")
      .update({
        price: price || data.price,
        image_url: image_url || data.image_url
      })
      .eq("code", code);
  }else{
    await supabase.from("products")
      .insert({ code, price, image_url });
  }

  codeInput.value="";
  priceInput.value="";
  imgInput.value="";
  load();
}

async function del(code, image_url){
  if(!confirm("确认删除？")) return;

  if(image_url){
    const path = image_url.split("/product-images/")[1];
    await supabase.storage.from("product-images").remove([path]);
  }

  await supabase.from("products").delete().eq("code", code);
  load();
}

async function load(){
  const { data } = await supabase
    .from("products")
    .select("*")
    .order("created_at",{ascending:false});

  list.innerHTML="";
  data.forEach(p=>{
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`
      <div class="header" onclick="this.nextElementSibling.style.display =
        this.nextElementSibling.style.display==='block'?'none':'block'">
        <b>${p.code}</b>
        <span>¥ ${p.price||"未设置"}</span>
      </div>
      <div class="content">
        <div class="price">¥ ${p.price||"未设置"}</div>
        ${p.image_url?`< img src="${p.image_url}">`:""}
        <div class="actions">
          <button class="delete" onclick="del('${p.code}','${p.image_url||""}')">
            删除
          </button>
        </div>
      </div>
    `;
    list.appendChild(d);
  });
}

load();
</script>

</body>
</html>
