<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>价格查询</title>
<meta name="format-detection" content="telephone=no">

<style>
  :root{
    --primary:#2d7ff9;
    --bg:#f5f7fb;
    --card:#ffffff;
  }
  html,body{
    height:100%;margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial;
    background:var(--bg);color:#222;
  }

  /* 顶部 */
  .topbar{
    display:flex;align-items:center;justify-content:space-between;
    padding:18px 14px;
  }
  .title{font-size:22px;font-weight:600;margin:0;text-align:left}
  .subtitle{
    font-size:13px;color:#ff4444;margin-top:2px;text-align:left;
  }

  .container{padding:0 14px 28px}
  .search-row{
    display:flex;gap:8px;justify-content:center;margin-top:10px
  }
  input[type="text"]{
    width:64%;max-width:320px;padding:12px;border-radius:10px;
    border:1px solid #d8d8d8;font-size:16px
  }
  button.btn{
    padding:12px 16px;border-radius:10px;border:none;
    background:var(--primary);color:#fff;font-size:16px
  }

  .hint{
    font-size:13px;color:#ff4444;text-align:center;margin-top:6px
  }

  /* 弹窗口整体居中 */
  .overlay{
    display:none;position:fixed;inset:0;
    justify-content:center;align-items:center;
    background:rgba(0,0,0,0.45);z-index:1200
  }

  /* Modal */
  .modal{
    background:var(--card);width:92%;max-width:420px;
    border-radius:14px;padding:20px 18px 26px;
    box-shadow:0 12px 40px rgba(0,0,0,0.12);
    position:relative;text-align:center;
  }
  .modal .close{
    position:absolute;right:12px;top:10px;font-size:22px;
    cursor:pointer;color:#666
  }
  .modal-title{
    font-size:24px;font-weight:700;margin:6px 0 10px
  }
  .modal-code{
    font-size:15px;color:#444;margin-bottom:8px
  }
  .modal-price{
    font-size:30px;font-weight:700;color:#0abf24;margin:10px 0 18px
  }
  .modal-no-price{
    font-size:22px;color:#d33;margin:10px 0 18px
  }

  /* 图片居中 + 放大到120×120 */
  #modalImage{
    width:120px;height:120px;object-fit:cover;
    border-radius:10px;border:1px solid #eee;
    display:none;margin:0 auto 14px auto;
  }

  .modal input[type="number"]{
    width:55%;padding:10px;font-size:16px;border-radius:8px;
    border:1px solid #ccc;margin:0 auto;display:block;
  }

  .save-btn{
    margin-top:14px;width:85%;max-width:300px;padding:12px;
    font-size:18px;border-radius:10px;
    background:var(--primary);color:#fff;border:none;
    display:block;margin-left:auto;margin-right:auto
  }

  .save-msg{
    margin-top:10px;color:#28a745;font-size:15px;
    display:none;text-align:center
  }

  /* 列表抽屉 */
  .menu-btn{
    background:transparent;border:none;padding:8px;
    border-radius:8px;color:var(--primary);font-size:16px;
  }

  .drawer{
    position:fixed;right:0;top:0;height:100%;
    width:92%;max-width:420px;background:var(--card);
    box-shadow:-8px 0 24px rgba(0,0,0,0.12);
    transform:translateX(100%);transition:transform .28s;
    z-index:1250;overflow:auto;
  }
  .drawer.open{transform:translateX(0)}
  .drawer-header{
    display:flex;align-items:center;justify-content:space-between;
    padding:16px 14px;border-bottom:1px solid #f0f0f0
  }

  .drawer-list{padding:10px}
  .item{
    display:flex;align-items:center;gap:12px;padding:10px;
    background:#fafafa;border-radius:10px;margin-bottom:10px
  }
  .thumb{
    width:50px;height:50px;border-radius:6px;background:#eee;
    object-fit:cover;border:1px solid #e6e6e6
  }
  .item-info{text-align:left;flex:1}
  .item-code{font-weight:600}
  .item-price{color:#0abf24;font-weight:700;margin-top:6px}

  .item-actions{
    display:flex;flex-direction:column;gap:6px
  }
  .small-btn{
    padding:6px 8px;border-radius:8px;border:1px solid #ddd;
    background:#fff;font-size:13px
  }

</style>
</head>
<body>

<!-- 顶部 -->
<div class="topbar">
  <div style="display:flex;flex-direction:column;">
    <div class="title">价格查询</div>
    <div class="subtitle">(请输入后 5 位数)</div>
  </div>
  <button class="menu-btn" id="openListBtn">☰ 列表</button>
</div>

<div class="container">
  <div class="search-row">
    <input id="codeInput" type="text" maxlength="5" placeholder="输入后5位或完整代码">
    <button class="btn" onclick="doSearch()">查询</button>
  </div>
  <div class="hint">（输入后5位，示例：12345）</div>
</div>

<!-- 抽屉商品列表 -->
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <div style="font-weight:700">已保存商品</div>
    <button class="small-btn" id="closeListBtn">关闭</button>
  </div>

  <div style="padding:12px">
    <input id="searchList" type="text" placeholder="搜索条码或价格"
      style="width:75%;padding:8px;border-radius:8px;border:1px solid #eee">
    <button class="small-btn" id="clearSearchList">清除</button>
  </div>

  <div class="drawer-list" id="listArea"></div>

  <div style="padding:12px;border-top:1px solid #f0f0f0">
    <button class="small-btn" id="exportBtn">导出 CSV</button>
    <input type="file" id="importFile" accept=".csv,image/*" style="display:none">
    <button class="small-btn" id="importBtn">导入 CSV</button>
    <button class="small-btn" id="clearDBBtn">清空库</button>
  </div>
</div>

<!-- 弹窗 -->
<div class="overlay" id="overlay">
  <div class="modal">
    <span class="close" onclick="closeOverlay()">×</span>

    <div id="modalTitle" class="modal-title">查询成功</div>
    <div id="modalCode" class="modal-code"></div>
    <div id="modalPrice" class="modal-price" style="display:none"></div>
    <div id="noPrice" class="modal-no-price" style="display:none">请录入价格</div>

    <img id="modalImage" src="">

    <input id="priceInput" type="number" step="0.01" placeholder="输入价格（保留两位）">
    <button class="save-btn" onclick="overlaySave()">保存</button>
    <div id="saveMsg" class="save-msg">保存成功</div>
  </div>
</div>

<script>
/* 数据结构 localStorage */
const KEY = "priceDB_v3";
let db = {};
function loadDB(){ db = JSON.parse(localStorage.getItem(KEY) || "{}"); }
function saveDB(){ localStorage.setItem(KEY, JSON.stringify(db)); }
loadDB();

/* DOM */
const drawer=document.getElementById("drawer");
const overlay=document.getElementById("overlay");
const modalImage=document.getElementById("modalImage");

document.getElementById("openListBtn").onclick=()=>{drawer.classList.add("open");renderList();}
document.getElementById("closeListBtn").onclick=()=>drawer.classList.remove("open");
document.getElementById("clearSearchList").onclick=()=>{document.getElementById("searchList").value="";renderList();};
document.getElementById("searchList").oninput=()=>renderList();

/* 查询 */
function doSearch(){
  const code=document.getElementById("codeInput").value.trim();
  if(!code){ alert("请输入代码"); return;}
  openOverlayFor(code);
}

/* 打开弹窗 */
function openOverlayFor(code){
  loadDB();
  const rec=db[code];
  document.getElementById("modalCode").innerText="商品代码："+code;
  document.getElementById("modalCode").dataset.code=code;

  if(rec && rec.price){
    document.getElementById("modalTitle").innerText="查询成功";
    document.getElementById("modalPrice").innerText="¥"+rec.price;
    document.getElementById("modalPrice").style.display="block";
    document.getElementById("noPrice").style.display="none";
    priceInput.value=rec.price;
  }else{
    document.getElementById("modalTitle").innerText="未找到价格";
    document.getElementById("modalPrice").style.display="none";
    document.getElementById("noPrice").style.display="block";
    priceInput.value="";
  }

  if(rec && rec.image){
    modalImage.src=rec.image;
    modalImage.style.display="block";
  }else{
    modalImage.style.display="none";
  }

  document.getElementById("saveMsg").style.display="none";
  overlay.style.display="flex";
}

function closeOverlay(){ overlay.style.display="none"; }

/* 保存 */
function overlaySave(){
  const code=document.getElementById("modalCode").dataset.code;
  let val=document.getElementById("priceInput").value.trim();
  if(!val||isNaN(val)){alert("请输入正确价格"); return;}
  val=parseFloat(val).toFixed(2);

  loadDB();
  if(!db[code]) db[code]={price:val,image:null};
  else db[code].price=val;
  saveDB();

  document.getElementById("modalPrice").innerText="¥"+val;
  document.getElementById("modalPrice").style.display="block";
  document.getElementById("noPrice").style.display="none";
  document.getElementById("saveMsg").style.display="block";

  renderList();
}

/* 列表渲染 */
function renderList(filter=""){
  const list=document.getElementById("listArea");
  list.innerHTML="";
  const keys=Object.keys(db).sort();
  if(keys.length==0){
    list.innerHTML='<div style="text-align:center;color:#777;padding:20px">暂无商品</div>';
    return;
  }

  keys.forEach(code=>{
    const r=db[code];
    if(filter){
      const f=filter.toLowerCase();
      if(!code.toLowerCase().includes(f) && !(r.price+"").includes(f)) return;
    }

    const div=document.createElement("div"); div.className="item";

    const img=document.createElement("img");
    img.className="thumb";
    img.src=r.image||"";
    div.appendChild(img);

    const info=document.createElement("div"); info.className="item-info";
    info.innerHTML=`<div class="item-code">${code}</div>
                    <div class="item-price">${r.price?"¥"+r.price:"未设置"}</div>`;
    div.appendChild(info);

    const acts=document.createElement("div"); acts.className="item-actions";
    const b1=document.createElement("button"); b1.className="small-btn"; b1.innerText="查看";
    b1.onclick=()=>openOverlayFor(code);
    const b2=document.createElement("button"); b2.className="small-btn"; b2.innerText="删除";
    b2.onclick=()=>{
      if(confirm("确认删除？")){
        delete db[code];
        saveDB();
        renderList(filter);
      }
    };
    acts.appendChild(b1); acts.appendChild(b2);
    div.appendChild(acts);

    list.appendChild(div);
  });
}

/* 点击图片可更换 */
(()=>{
  const inp=document.createElement("input");
  inp.type="file"; inp.accept="image/*"; inp.style.display="none";
  document.body.appendChild(inp);

  modalImage.onclick=()=>inp.click();
  inp.onchange=e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=ev=>{
      const code=document.getElementById("modalCode").dataset.code;
      loadDB();
      if(!db[code]) db[code]={price:null,image:ev.target.result};
      else db[code].image=ev.target.result;
      saveDB();
      modalImage.src=ev.target.result;
      modalImage.style.display="block";
      renderList();
    };
    r.readAsDataURL(f);
    inp.value='';
  };
})();

</script>

</body>
</html>
